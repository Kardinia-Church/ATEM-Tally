# NodeMCUTallyLight
A tally light for a blackmagic switcher. This uses a nodeMCU and a nodered script running from the [blackmagic-atem-nodered](https://www.npmjs.com/package/blackmagic-atem-nodered).


### Script to translate blackmagic commands to broadcast packets sent to the nodes
```
[{"id":"23e2e7f9.028308","type":"atem-atem","z":"a9a9c4f6.2cf508","name":"Auditorium ATEM","network":"c8cac07b.eda62","outputMode":"supported","sendInitialData":"yes","sendStatusUpdates":"yes","x":630,"y":160,"wires":[["3a4c4f60.d4063"]]},{"id":"3a4c4f60.d4063","type":"function","z":"a9a9c4f6.2cf508","name":"Tally Lights v2","func":"if(msg.payload.cmd == \"inputProperty\"){\n    var output = {\n        \"payload\": new Buffer(0),\n        \"check\": 0\n    }\n    \n    var i = 0;\n    for(var key in msg.payload.data.inputs) {\n        if(key <= 20) {\n            var currentBuffer = Buffer(5);\n            var input = msg.payload.data.inputs[key];\n            currentBuffer.writeUInt16BE(input.id, 0);\n            currentBuffer[2] = input.tallys.programTally.state ? 0x01 : 0x00;\n            currentBuffer[3] = input.tallys.previewTally.state ? 0x01 : 0x00;\n            currentBuffer[4] = (input.tallys.downstreamKeyerTallyFill.state || input.tallys.downstreamKeyerTallyKey.state ||input.tallys.upstreamKeyerTallyFill.state || input.tallys.upstreamKeyerTallyKey.state) ? 0x01 : 0x00;\n            output.payload = Buffer.concat([output.payload, currentBuffer]);\n            for(var j = 2; j < 5; j++){output.check += currentBuffer[j] * input.id;}\n        }\n    }\n    return [output, undefined];\n}\n\nif(msg.payload.cmd == \"programInput\" || msg.payload.cmd == \"previewInput\" || msg.payload.cmd == \"downstreamKeyer\" || msg.payload.cmd == \"upstreamKeyer\") {\n    return [undefined, {\n        \"payload\": {\n            \"cmd\": \"inputProperty\",\n            \"data\": {}\n        }\n    }];\n}","outputs":2,"noerr":0,"x":820,"y":160,"wires":[["2f3da66d.f6c6aa"],["23e2e7f9.028308"]],"outputLabels":["To Tally","ATEM"]},{"id":"2f3da66d.f6c6aa","type":"udp out","z":"a9a9c4f6.2cf508","name":"Broadcast","addr":"192.168.0.255","iface":"","port":"5654","ipv":"udp4","outport":"","base64":false,"multicast":"broad","x":980,"y":120,"wires":[]},{"id":"d849d39a.98167","type":"udp in","z":"a9a9c4f6.2cf508","name":"Incoming from TallyLights","iface":"","port":"8000","ipv":"udp4","multicast":"false","group":"","datatype":"utf8","x":210,"y":160,"wires":[["9f43d8d0.d06978"]]},{"id":"9f43d8d0.d06978","type":"function","z":"a9a9c4f6.2cf508","name":"Data request tallys","func":"if(msg.payload == \"dataRequest\") {\n    var msg1 = {\n        \"payload\": {\n            \"cmd\": \"inputProperty\",\n            \"data\": {}\n        }\n    }\n    return msg1;\n}","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["23e2e7f9.028308"]]},{"id":"c8cac07b.eda62","type":"atem-network","z":"","name":"Auditorium ATEM","ipAddress":"192.168.0.1"}]
```

### Hardware information
* LED type is a PL9823
* LED pins are in series with the rear led being first and front being last on D2
